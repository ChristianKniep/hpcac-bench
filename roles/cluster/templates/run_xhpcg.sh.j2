#!/bin/bash
#SBATCH --ntasks-per-node={{ ansible_processor_vcpus }}
#SBATCH --workdir={{ home_dir }}/cluser/{{ run_host }}
#SBATCH --job-name={{ job_size }}_{{ job_time }}

# ENV
source /etc/bashrc
module unload mpi
module load mpi/{{ mpi_version }}
# \ENV

mkdir -p ${SLURM_JOBID}
cd ${SLURM_JOBID}
cat << EOF > hpcg.dat
HPCG benchmark input file
Sandia National Laboratories; University of Tennessee, Knoxville
{{ job_size }} {{ job_size }} {{ job_size }}
{{ job_time }}
EOF

echo "## $(date +'%F %H:%M:%S') Start mpirun with '{{ job_size }}^3 in {{ job_time }}sec' input deck"
mpirun --mca btl "self,openib"  {{ home_dir }}/cluser/hpcg-2.4/{{ run_host }}_OMP-SYS/bin/xhpcg
echo "## $(date +'%F %H:%M:%S') Job ends"
eval_hpcg.py HPCG-Benchmark-*.yaml

