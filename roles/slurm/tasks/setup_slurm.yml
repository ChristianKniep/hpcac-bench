---
- name: ensure slurm rpms and dependencies are present
  when: not is_container is defined
  yum: pkg={{ item }} state=present
  tags: 
  - slurm
  - rpm
  with_items:
     - slurm

- name: create slurm group
  tags:
  - user
  - slurm
  action: group name=slurm gid=5000 system=no

- name: create slurm user
  tags:
  - user
  - slurm
  action: user name=slurm group=slurm shell=/bin/false uid=5000 createhome=no home=/opt/slurm

- name: create a slurm config dir
  tags: slurm
  file: path=/etc/slurm/ mode=0755 state=directory

- name: create slurm dirs
  tags: slurm
  file: path=/var/{{ item }}/slurm/ owner=slurm mode=0755 state=directory
  with_items:
    - lib
    - log
    - run

- name: create slurm directories
  tags: slurm
  file: path=/var/spool/slurmd owner=slurm mode=0755 state=directory

- name: restart munged service
  tags: 
  - slurm
  supervisorctl: name=munged state=restarted

- name: installp slurm accounting
  when: is_master is defined
  yum: pkg={{ item }} state=present
  tags: 
  - slurm
  - sacct
  with_items:
     - mariadb-server

- name: Start the MySQL service
  when: is_master is defined
  tags: 
  - slurm
  - sacct
  action: service name=mariadb state=started

- name: Configure the initial root credentials (fails if already set)
  when: is_master is defined
  tags: 
  - slurm
  - sacct
  action: command mysqladmin -u root password {{ mysql_root_password }} 
  ignore_errors: yes

- name: Set up slurmDBD database
  when: is_master is defined
  tags: 
  - slurm
  - sacct
  command: mysql -u root -pmysql -e "create database slurm_acct_db;"
  ignore_errors: yes

- name: Grant permissions to slurmDBD database
  when: is_master is defined
  tags: 
  - slurm
  - sacct
  action: command mysql -u root -p{{ mysql_root_password }} -D slurm_acct_db -e \
                        "grant all on slurm_acct_db.* TO '{{ slurmdbd_user }}'@'localhost' identified by '{{ slurmdbd_pw }}' with grant option;"

- name: Grant permissions to slurmDBD database
  when: is_master is defined
  tags: 
  - slurm
  - sacct
  action: command mysql -u root -p{{ mysql_root_password }} -D slurm_acct_db -e \
                        "grant all on slurm_acct_db.* TO '{{ slurmdbd_user }}'@'localhost' identified by '{{ slurmdbd_pw }}' with grant option;"

- name: configure slurmdbd
  when: is_master is defined 
  action: template src=usr/local/etc/slurmdbd.conf.j2 dest=/usr/local/etc/slurmdbd.conf owner=root group=root mode=0644
  tags: 
  - slurm
  - sacct


## Slurm.conf

- name: configure slurm (master)
  when: is_master is defined 
  action: template src=usr/local/etc/{{ slurm_conf_template }} dest=/usr/local/etc/slurm.conf owner=root group=root mode=0644
  tags: 
  - slurm
  - cfg
  notify: 
  - restart slurmctld
  - restart slurmd

- name: create slurm directories
  tags: slurm
  file: path=/var/spool/slurmd owner=slurm mode=0755 state=directory

- name: configure slurmd
  action: template src=usr/local/etc/{{ slurm_conf_template }} dest=/usr/local/etc/slurm.conf owner=root group=root mode=0644
  when: not is_master is defined  and not is_container
  tags: 
  - slurm
  - cfg
  notify: restart slurmd

- name: LD_LIBRARY_PATH to find libmunge
  tags:
    - env
  lineinfile:
    dest=/etc/bashrc
    line="export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:/usr/local/lib/"
    regexp=".*export LD_LIBRARY_PATH="
    owner=root
    state=present
    insertafter=EOF
    create=True


