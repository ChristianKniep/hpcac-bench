---
- hosts: all
  remote_user: root
  vars:
    docker_socket: tcp://0.0.0.0:6000
    docker_data: /var/lib/docker/
  tasks:
  - name: add repositories
    tags: base
    copy: src=files/etc/yum.repos.d/{{ item }}.repo dest=/etc/yum.repos.d/{{ item }}.repo owner=root group=root mode=0644
    with_items:
      - qnib
      - epel
  - include: tasks/basic_pkg.yml
  - include: tasks/users.yml
  - include: tasks/docker.yml
  - include: tasks/cluster_env.yml
  - name: stop firewalld
    tags: base
    service: name=firewalld state=stopped enabled=no
  - name: disable selinux
    tags: base
    selinux: state=disabled
  - include: tasks/setup_monitoring.yml
  - include: tasks/setup_slurm.yml
  handlers:
  - include: handlers/services.yml
  
- hosts: master
  remote_user: root
  tasks:
  - include: tasks/create_mfiles.yml
  #- include: tasks/nfs.yml
  #- include: tasks/start_reg.yml
  - include: tasks/compile_hpcc.yml

- hosts: slaves
  remote_user: root
  vars:
  tasks:
  #- include: tasks/nfs-clients.yml nfsserver={{ groups.master[0] }} nfspath=/opt/nfs/chome nfsmount=/chome
  #- include: tasks/nfs-clients.yml nfsserver={{ groups.master[0] }} nfspath=/opt/nfs/scratch nfsmount=/scratch
  #- include: tasks/users.yml
